name: Update ELO Data

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  push:
    branches:
      - main

jobs:
  update-elo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Fetch ELO Data and Update JSON
        run: |
          echo "[]" > elo_data.json
          for profileId in 8425727 262331 7104296 2259426; do
            elo1v1=$(curl -s "https://www.aoe2insights.com/nightbot/rank/3/?query=$profileId")
            eloTeam=$(curl -s "https://www.aoe2insights.com/nightbot/rank/4/?query=$profileId")
            jq --arg profileId "$profileId" --arg elo1v1 "$elo1v1" --arg eloTeam "$eloTeam" \
              '. += [{"profileId": $profileId, "elo1v1": $elo1v1, "eloTeam": $eloTeam}]' \
              elo_data.json > tmp.json && mv tmp.json elo_data.json
          done

      - name: Commit and Push JSON
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add elo_data.json
          git commit -m "Update ELO data"
          git push
